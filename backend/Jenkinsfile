pipeline {
    agent any
    
    // Otomatik build tetikleme: GitHub'a push yapıldığında veya belirli aralıklarla
    triggers {
        // Poll SCM: Her 2 dakikada bir GitHub'ı kontrol et (yeni commit varsa build başlatır)
        pollSCM('H/2 * * * *')
        
        // Alternatif: GitHub webhook kullanmak isterseniz, Jenkins'te "GitHub hook trigger for GITScm polling" seçeneğini işaretleyin
        // ve bu satırı yorum satırı yapın
    }
    
    environment {
        // Maven ve Java PATH'leri (container'da mevcut)
        PATH = "/usr/bin:/opt/java/openjdk/bin:${env.PATH}"
        JAVA_HOME = '/opt/java/openjdk'
        M2_HOME = '/usr/share/maven'
        // Test veritabanı için (Docker Compose network içinden)
        TEST_DB_URL = 'jdbc:postgresql://postgres:5432/yazilimdogrulama_test'
        TEST_DB_USER = 'postgres'
        TEST_DB_PASSWORD = 'postgres'
        
        // Frontend URL (Selenium testleri için - host'tan erişim)
        // Docker Desktop için: host.docker.internal
        // Linux için: 172.17.0.1 veya host IP
        FRONTEND_URL = "${env.FRONTEND_URL ?: 'http://host.docker.internal:5173'}"
        
        // Backend URL (Docker Compose network içinden)
        BACKEND_URL = 'http://backend:8080'
        
        // CI ortamı flag'i (Selenium headless mod için)
        CI = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Git repository\'den kod çekiliyor...'
                checkout scm
            }
        }
        
        stage('Clean') {
            steps {
                echo 'Maven clean işlemi yapılıyor...'
                dir('backend') {
                    sh 'mvn clean'
                }
            }
        }
        
        stage('Compile') {
            steps {
                echo 'Kod derleniyor...'
                dir('backend') {
                    sh 'mvn compile'
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'Unit testler çalıştırılıyor...'
                dir('backend') {
                    sh 'mvn clean test jacoco:report -Dtest="*ServiceImplTest"'
                }
            }
            post {
                always {
                    // Test sonuçlarını kaydet
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu kaydet
                    publishHTML([
                        reportDir: 'backend/target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report (Unit Tests)',
                        keepAll: true
                    ])
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                echo 'Entegrasyon testleri çalıştırılıyor...'
                script {
                    try {
                        // PostgreSQL test veritabanının hazır olduğundan emin ol
                        // Docker Compose network içinden postgres container'ına erişim
                        sh '''
                            # Test veritabanını kontrol et ve oluştur (eğer yoksa)
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "SELECT 1 FROM pg_database WHERE datname='yazilimdogrulama_test'" | grep -q 1 || \
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "CREATE DATABASE yazilimdogrulama_test"
                        '''
                    } catch (Exception e) {
                        echo "Veritabanı kontrolü atlandı: ${e.getMessage()}"
                    }
                }
                dir('backend') {
                    // Docker Compose network'ünden postgres'e erişim için Maven system property override
                    // JaCoCo agent zaten prepare-agent ile hazırlanmış olmalı
                    sh '''
                        mvn test jacoco:report -Dtest="*IntegrationTest" \
                            -Dspring.datasource.url=jdbc:postgresql://postgres:5432/yazilimdogrulama_test \
                            -Dspring.datasource.username=postgres \
                            -Dspring.datasource.password=postgres
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu kaydet
                    publishHTML([
                        reportDir: 'backend/target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report (Integration Tests)',
                        keepAll: true
                    ])
                }
            }
        }
        
        stage('Selenium Tests') {
            steps {
                echo 'Selenium testleri çalıştırılıyor...'
                script {
                    // Frontend ve Backend'in çalıştığından emin ol
                    sh '''
                        # Backend'in çalıştığını kontrol et (network içinden)
                        timeout 30 bash -c 'until curl -f http://backend:8080/api/auth/kayit || [ $? -eq 22 ]; do sleep 2; done' || echo "Backend kontrolü atlandı"
                        
                        # Frontend'in çalıştığını kontrol et (host'tan erişim)
                        timeout 30 bash -c 'until curl -f ${FRONTEND_URL} || [ $? -eq 22 ]; do sleep 2; done' || echo "Frontend kontrolü atlandı"
                    '''
                }
                dir('backend') {
                    sh 'mvn test jacoco:report -Dtest="*Selenium*Test" -Dselenium.headless=true'
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // Selenium screenshot'larını kaydet (eğer varsa)
                    archiveArtifacts artifacts: 'backend/target/screenshots/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Code Coverage Report') {
            steps {
                echo 'Tüm testler için birleşik coverage raporu oluşturuluyor...'
                dir('backend') {
                    // Tüm testler için birleşik coverage raporu oluştur
                    sh 'mvn jacoco:report-aggregate'
                }
            }
            post {
                always {
                    // Birleşik coverage raporunu kaydet
                    publishHTML([
                        reportDir: 'backend/target/site/jacoco-aggregate',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report (All Tests)',
                        keepAll: true
                    ])
                    // JaCoCo XML raporunu da kaydet (Jenkins JaCoCo plugin için)
                    publishCoverage adapters: [
                        jacocoAdapter('backend/target/site/jacoco-aggregate/jacoco.xml')
                    ], sourceFileResolver: sourceFiles('STORE_LAST_BUILD')
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'JAR dosyası oluşturuluyor...'
                dir('backend') {
                    sh 'mvn package -DskipTests'
                }
            }
            post {
                success {
                    // Başarılı build sonrası JAR'ı kaydet
                    archiveArtifacts artifacts: 'backend/target/*.jar', allowEmptyArchive: false
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline tamamlandı.'
            script {
                def testResults = sh(
                    script: 'find backend/target/surefire-reports -name "*.xml" -exec grep -l "testsuite" {} \\; | wc -l',
                    returnStdout: true
                ).trim()
                echo "Test dosyası sayısı: ${testResults}"
            }
        }
        success {
            echo '✅ Tüm testler başarılı!'
            // İsteğe bağlı: Slack, Email bildirimi eklenebilir
        }
        failure {
            echo '❌ Testler başarısız oldu!'
            // İsteğe bağlı: Hata bildirimi
        }
        unstable {
            echo '⚠️ Bazı testler başarısız oldu!'
        }
    }
}

