pipeline {
    agent any
    
    // Otomatik build tetikleme: GitHub'a push yapÄ±ldÄ±ÄŸÄ±nda veya belirli aralÄ±klarla
    triggers {
        // Poll SCM: Her 2 dakikada bir GitHub'Ä± kontrol et (yeni commit varsa build baÅŸlatÄ±r)
        pollSCM('H/2 * * * *')
        
        // Alternatif: GitHub webhook kullanmak isterseniz, Jenkins'te "GitHub hook trigger for GITScm polling" seÃ§eneÄŸini iÅŸaretleyin
        // ve bu satÄ±rÄ± yorum satÄ±rÄ± yapÄ±n
    }
    
    environment {
        // Maven ve Java PATH'leri (container'da mevcut)
        PATH = "/usr/bin:/opt/java/openjdk/bin:${env.PATH}"
        JAVA_HOME = '/opt/java/openjdk'
        M2_HOME = '/usr/share/maven'
        // Test veritabanÄ± iÃ§in (Docker Compose network iÃ§inden)
        TEST_DB_URL = 'jdbc:postgresql://postgres:5432/yazilimdogrulama_test'
        TEST_DB_USER = 'postgres'
        TEST_DB_PASSWORD = 'postgres'
        
        // Frontend URL (Selenium testleri iÃ§in - host'tan eriÅŸim)
        // Docker Desktop iÃ§in: host.docker.internal
        // Linux iÃ§in: 172.17.0.1 veya host IP
        FRONTEND_URL = "${env.FRONTEND_URL ?: 'http://host.docker.internal:5173'}"
        
        // Backend URL (Docker Compose network iÃ§inden)
        BACKEND_URL = 'http://backend:8080'
        
        // CI ortamÄ± flag'i (Selenium headless mod iÃ§in)
        CI = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Git repository\'den kod Ã§ekiliyor...'
                checkout scm
            }
        }
        
        stage('Clean') {
            steps {
                echo 'Maven clean iÅŸlemi yapÄ±lÄ±yor...'
                dir('backend') {
                    sh 'mvn clean'
                }
            }
        }
        
        stage('Compile') {
            steps {
                echo 'Kod derleniyor...'
                dir('backend') {
                    sh 'mvn compile'
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'Unit testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                dir('backend') {
                    sh 'mvn clean test jacoco:report -Dtest="*ServiceImplTest"'
                }
            }
            post {
                always {
                    // Test sonuÃ§larÄ±nÄ± kaydet
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu artifact olarak kaydet (sadece dosya varsa)
                    script {
                        if (fileExists('backend/target/site/jacoco/index.html')) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi."
                        } else {
                            echo "âš ï¸ Coverage raporu bulunamadÄ± (Unit Tests)"
                        }
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                echo 'Entegrasyon testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    try {
                        // PostgreSQL test veritabanÄ±nÄ±n hazÄ±r olduÄŸundan emin ol
                        // Docker Compose network iÃ§inden postgres container'Ä±na eriÅŸim
                        sh '''
                            # Test veritabanÄ±nÄ± kontrol et ve oluÅŸtur (eÄŸer yoksa)
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "SELECT 1 FROM pg_database WHERE datname='yazilimdogrulama_test'" | grep -q 1 || \
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "CREATE DATABASE yazilimdogrulama_test"
                        '''
                    } catch (Exception e) {
                        echo "VeritabanÄ± kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                    }
                }
                dir('backend') {
                    // Docker Compose network'Ã¼nden postgres'e eriÅŸim iÃ§in Maven system property override
                    // JaCoCo agent zaten prepare-agent ile hazÄ±rlanmÄ±ÅŸ olmalÄ±
                    sh '''
                        mvn test jacoco:report -Dtest="*IntegrationTest" \
                            -Dspring.datasource.url=jdbc:postgresql://postgres:5432/yazilimdogrulama_test \
                            -Dspring.datasource.username=postgres \
                            -Dspring.datasource.password=postgres
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu artifact olarak kaydet (sadece dosya varsa)
                    script {
                        if (fileExists('backend/target/site/jacoco/index.html')) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi."
                        } else {
                            echo "âš ï¸ Coverage raporu bulunamadÄ± (Integration Tests)"
                        }
                    }
                }
            }
        }
        
        stage('Selenium Tests') {
            steps {
                echo 'Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    // Frontend ve Backend'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol
                    sh '''
                        # Backend'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et (network iÃ§inden)
                        timeout 30 bash -c 'until curl -f http://backend:8080/api/auth/kayit || [ $? -eq 22 ]; do sleep 2; done' || echo "Backend kontrolÃ¼ atlandÄ±"
                        
                        # Frontend'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et (host'tan eriÅŸim)
                        timeout 30 bash -c 'until curl -f ${FRONTEND_URL} || [ $? -eq 22 ]; do sleep 2; done' || echo "Frontend kontrolÃ¼ atlandÄ±"
                    '''
                }
                dir('backend') {
                    sh 'mvn test jacoco:report -Dtest="*Selenium*Test" -Dselenium.headless=true'
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // Selenium screenshot'larÄ±nÄ± kaydet (eÄŸer varsa)
                    archiveArtifacts artifacts: 'backend/target/screenshots/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Code Coverage Report') {
            steps {
                echo 'TÃ¼m testler iÃ§in birleÅŸik coverage raporu oluÅŸturuluyor...'
                dir('backend') {
                    // TÃ¼m testler iÃ§in birleÅŸik coverage raporu oluÅŸtur
                    sh 'mvn jacoco:report-aggregate'
                    
                    // DosyanÄ±n oluÅŸtuÄŸunu kontrol et
                    sh '''
                        if [ -f "target/site/jacoco-aggregate/index.html" ]; then
                            echo "âœ… Coverage raporu baÅŸarÄ±yla oluÅŸturuldu"
                            ls -la target/site/jacoco-aggregate/
                        else
                            echo "âš ï¸ Coverage raporu bulunamadÄ±, jacoco:report Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                            mvn jacoco:report
                        fi
                    '''
                }
            }
            post {
                always {
                    script {
                        // DosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et ve artifact olarak kaydet
                        def coverageFile = 'backend/target/site/jacoco-aggregate/index.html'
                        if (fileExists(coverageFile)) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false
                            echo "âœ… BirleÅŸik coverage raporu artifact olarak kaydedildi!"
                        } else {
                            // Alternatif: Normal jacoco raporunu kaydet
                            if (fileExists('backend/target/site/jacoco/index.html')) {
                                archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                                echo "âœ… Coverage raporu (normal) artifact olarak kaydedildi!"
                            } else {
                                echo "âš ï¸ Coverage raporu bulunamadÄ±, artifact kaydedilemedi"
                            }
                        }
                    }
                    echo "ğŸ“ Coverage raporuna eriÅŸmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'target/site/jacoco-aggregate/index.html' dosyasÄ±nÄ± indirin."
                    echo "ğŸ’¡ HTML Publisher Plugin yÃ¼klerseniz, raporlar otomatik olarak gÃ¶rÃ¼ntÃ¼lenebilir."
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'JAR dosyasÄ± oluÅŸturuluyor...'
                dir('backend') {
                    sh 'mvn package -DskipTests'
                }
            }
            post {
                success {
                    // BaÅŸarÄ±lÄ± build sonrasÄ± JAR'Ä± kaydet
                    archiveArtifacts artifacts: 'backend/target/*.jar', allowEmptyArchive: false
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline tamamlandÄ±.'
            script {
                def testResults = sh(
                    script: 'find backend/target/surefire-reports -name "*.xml" -exec grep -l "testsuite" {} \\; | wc -l',
                    returnStdout: true
                ).trim()
                echo "Test dosyasÄ± sayÄ±sÄ±: ${testResults}"
                
                // Coverage raporu bilgisi ve artifact kaydetme
                script {
                    try {
                        def coverageFile = 'backend/target/site/jacoco-aggregate/index.html'
                        if (fileExists(coverageFile)) {
                            echo "âœ… Coverage raporu oluÅŸturuldu: ${coverageFile}"
                            // Global post'ta da artifact kaydet (Jenkins UI'da gÃ¶rÃ¼nmesi iÃ§in)
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false, fingerprint: true
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi!"
                            echo "ğŸ“ Coverage raporunu gÃ¶rmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'backend/target/site/jacoco-aggregate/index.html' dosyasÄ±nÄ± indirin."
                        } else {
                            // Alternatif: Normal jacoco raporunu kaydet
                            def normalCoverageFile = 'backend/target/site/jacoco/index.html'
                            if (fileExists(normalCoverageFile)) {
                                archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false, fingerprint: true
                                echo "ğŸ“Š Coverage raporu (normal) artifact olarak kaydedildi!"
                            } else {
                                echo "âš ï¸ Coverage raporu bulunamadÄ±"
                            }
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ Coverage raporu kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                    }
                }
            }
        }
        success {
            echo 'âœ… TÃ¼m testler baÅŸarÄ±lÄ±!'
            // Ä°steÄŸe baÄŸlÄ±: Slack, Email bildirimi eklenebilir
        }
        failure {
            echo 'âŒ Testler baÅŸarÄ±sÄ±z oldu!'
            // Ä°steÄŸe baÄŸlÄ±: Hata bildirimi
        }
        unstable {
            echo 'âš ï¸ BazÄ± testler baÅŸarÄ±sÄ±z oldu!'
        }
    }
}

