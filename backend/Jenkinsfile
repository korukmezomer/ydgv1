pipeline {
    agent any
    
    // Otomatik build tetikleme: GitHub'a push yapÄ±ldÄ±ÄŸÄ±nda veya belirli aralÄ±klarla
    triggers {
        // Poll SCM: Her 2 dakikada bir GitHub'Ä± kontrol et (yeni commit varsa build baÅŸlatÄ±r)
        pollSCM('H/2 * * * *')
        
        // Alternatif: GitHub webhook kullanmak isterseniz, Jenkins'te "GitHub hook trigger for GITScm polling" seÃ§eneÄŸini iÅŸaretleyin
        // ve bu satÄ±rÄ± yorum satÄ±rÄ± yapÄ±n
    }
    
    environment {
        // Maven ve Java PATH'leri (container'da mevcut)
        PATH = "/usr/bin:/opt/java/openjdk/bin:${env.PATH}"
        JAVA_HOME = '/opt/java/openjdk'
        M2_HOME = '/usr/share/maven'
        // Test veritabanÄ± iÃ§in (Docker Compose network iÃ§inden)
        TEST_DB_URL = 'jdbc:postgresql://postgres:5432/yazilimdogrulama_test'
        TEST_DB_USER = 'postgres'
        TEST_DB_PASSWORD = 'postgres'
        
        // Frontend URL (Selenium testleri iÃ§in - host'tan eriÅŸim)
        // Frontend host'ta Ã§alÄ±ÅŸÄ±yor, Jenkins container'Ä±ndan host.docker.internal ile eriÅŸiliyor
        FRONTEND_URL = 'http://host.docker.internal:5173'
        
        // Backend URL (Selenium testleri iÃ§in - browser'dan backend'e eriÅŸim)
        // Browser Jenkins container'Ä±nda Ã§alÄ±ÅŸÄ±yor, backend host'ta expose edilmiÅŸ
        // Browser'dan backend'e istek giderken host.docker.internal:8080 kullanÄ±lmalÄ±
        BACKEND_URL = 'http://host.docker.internal:8080'
        
        // CI ortamÄ± flag'i (Selenium headless mod iÃ§in)
        CI = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Git repository'den kod Ã§ekiliyor..."
                checkout scm
            }
        }
        
        stage('Clean') {
            steps {
                echo 'Maven clean iÅŸlemi yapÄ±lÄ±yor...'
                dir('backend') {
                    sh 'mvn clean'
                }
            }
        }
        
        stage('Compile') {
            steps {
                echo 'Kod derleniyor...'
                dir('backend') {
                    sh 'mvn compile'
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'Unit testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                dir('backend') {
                    // Unit testleri Ã§alÄ±ÅŸtÄ±r ve exec dosyasÄ±nÄ± ayrÄ± kaydet
                    // Pattern: TÃ¼m Test sÄ±nÄ±flarÄ± ama Selenium ve Integration hariÃ§
                    // Maven Surefire'da exclude iÃ§in pom.xml'de configuration gerekir, bu yÃ¼zden
                    // tÃ¼m unit test pattern'lerini manuel olarak belirtiyoruz
                    sh '''
                        # Unit testleri Ã§alÄ±ÅŸtÄ±r (Selenium ve Integration hariÃ§)
                        # TÃ¼m unit test pattern'lerini kullan (Service, Util, Config, Entity, DTO, Exception, Provider, Initializer, vb.)
                        # JaCoCo agent'Ä± hazÄ±rla ve testleri aynÄ± komutta Ã§alÄ±ÅŸtÄ±r
                        mvn jacoco:prepare-agent test \
                            -Djacoco.destFile=target/jacoco-unit.exec \
                            -Djacoco.propertyName=argLine \
                            -Dtest="*ServiceImplTest,*PojoTest,*UtilTest,*ConfigTest,*ExceptionTest,*FilterTest,*HandlerTest,*EntityTest,*ProviderTest,*InitializerTest" \
                            -DfailIfNoTests=false || true
                        
                        # Exec dosyasÄ±nÄ± kontrol et
                        if [ -f "target/jacoco-unit.exec" ]; then
                            echo "âœ… Unit test exec dosyasÄ± oluÅŸturuldu: target/jacoco-unit.exec"
                            ls -lh target/jacoco-unit.exec
                            echo "ğŸ“Š Unit test exec dosyasÄ± boyutu:"
                            du -sh target/jacoco-unit.exec
                        else
                            echo "âš ï¸ Unit test exec dosyasÄ± oluÅŸturulamadÄ±"
                        fi
                    '''
                }
            }
            post {
                always {
                    // Test sonuÃ§larÄ±nÄ± kaydet
                    junit 'backend/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                echo 'Entegrasyon testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    try {
                        // PostgreSQL test veritabanÄ±nÄ±n hazÄ±r olduÄŸundan emin ol
                        // Docker Compose network iÃ§inden postgres container'Ä±na eriÅŸim
                        sh '''
                            # Test veritabanÄ±nÄ± kontrol et ve oluÅŸtur (eÄŸer yoksa)
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "SELECT 1 FROM pg_database WHERE datname='yazilimdogrulama_test'" | grep -q 1 || \
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "CREATE DATABASE yazilimdogrulama_test"
                        '''
                    } catch (Exception e) {
                        echo "VeritabanÄ± kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                    }
                }
                dir('backend') {
                    // Integration testleri Ã§alÄ±ÅŸtÄ±r ve exec dosyasÄ±nÄ± ayrÄ± kaydet
                    sh '''
                        # JaCoCo agent'Ä± hazÄ±rla ve testleri aynÄ± komutta Ã§alÄ±ÅŸtÄ±r
                        mvn jacoco:prepare-agent test \
                            -Djacoco.destFile=target/jacoco-integration.exec \
                            -Djacoco.propertyName=argLine \
                            -Dtest="*IntegrationTest" \
                            -Dspring.datasource.url=jdbc:postgresql://postgres:5432/yazilimdogrulama_test \
                            -Dspring.datasource.username=postgres \
                            -Dspring.datasource.password=postgres || true
                        
                        # Exec dosyasÄ±nÄ± kontrol et
                        if [ -f "target/jacoco-integration.exec" ]; then
                            echo "âœ… Integration test exec dosyasÄ± oluÅŸturuldu: target/jacoco-integration.exec"
                            ls -lh target/jacoco-integration.exec
                        else
                            echo "âš ï¸ Integration test exec dosyasÄ± oluÅŸturulamadÄ±"
                        fi
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Selenium Tests') {
            steps {
                echo 'Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    // Frontend ve Backend'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et (sadece bilgilendirme amaÃ§lÄ±)
                    // Testler kendi iÃ§inde eriÅŸilebilirlik kontrolÃ¼ yapacak
                    sh '''
                        echo "ğŸ” Servis eriÅŸilebilirlik kontrolÃ¼ yapÄ±lÄ±yor (bilgilendirme amaÃ§lÄ±)..."
                        
                        # Backend kontrolÃ¼ (Jenkins container'Ä±ndan backend container'Ä±na)
                        echo "ğŸ“¡ Backend kontrolÃ¼: http://backend:8080"
                        BACKEND_RESPONSE=$(curl -s -w "%{http_code}" --max-time 5 http://backend:8080/api/auth/kayit -o /dev/null 2>&1 || echo "000")
                        if [ "$BACKEND_RESPONSE" = "200" ] || [ "$BACKEND_RESPONSE" = "405" ] || [ "$BACKEND_RESPONSE" = "500" ]; then
                            echo "âœ… Backend http://backend:8080 eriÅŸilebilir (HTTP $BACKEND_RESPONSE)"
                        else
                            echo "âš ï¸ Backend http://backend:8080 eriÅŸilemiyor (HTTP $BACKEND_RESPONSE) - Testler kendi kontrolÃ¼nÃ¼ yapacak"
                        fi
                        
                        # Frontend kontrolÃ¼ (Jenkins container'Ä±ndan host'taki frontend'e)
                        echo "ğŸ“¡ Frontend kontrolÃ¼: http://host.docker.internal:5173"
                        if curl -f -s --max-time 5 http://host.docker.internal:5173 > /dev/null 2>&1; then
                            echo "âœ… Frontend http://host.docker.internal:5173 eriÅŸilebilir"
                        else
                            echo "âš ï¸ Frontend http://host.docker.internal:5173 eriÅŸilemiyor - Testler kendi kontrolÃ¼nÃ¼ yapacak"
                        fi
                        
                        echo "â„¹ï¸ Not: EriÅŸilebilirlik kontrolÃ¼ baÅŸarÄ±sÄ±z olsa bile testler Ã§alÄ±ÅŸtÄ±rÄ±lacak."
                        echo "â„¹ï¸ Testler kendi iÃ§inde servis eriÅŸilebilirliÄŸini kontrol edecek."
                    '''
                }
                dir('backend') {
                    sh '''
                        echo "ğŸ§ª Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                        echo "ğŸ“¡ Frontend URL: ${FRONTEND_URL}"
                        echo "ğŸ“¡ Backend URL: ${BACKEND_URL}"
                        echo "ğŸ“¡ Test DB URL: ${TEST_DB_URL}"
                        echo "ğŸ“¡ Test DB User: ${TEST_DB_USER}"
                        
                        # Test sayÄ±sÄ±nÄ± gÃ¶ster
                        echo "ğŸ“Š Selenium test sÄ±nÄ±flarÄ±:"
                        find src/test/java/com/example/backend/selenium -name "*Test.java" -type f | sort
                        TEST_COUNT=$(find src/test/java/com/example/backend/selenium -name "*Test.java" -type f | wc -l)
                        echo "ğŸ“Š Toplam test sÄ±nÄ±fÄ± sayÄ±sÄ±: ${TEST_COUNT}"
                        
                        # Maven'in testleri bulup bulamadÄ±ÄŸÄ±nÄ± kontrol et
                        echo "ğŸ” Maven test discovery kontrolÃ¼..."
                        echo "Test pattern: com.example.backend.selenium.*Test"
                        mvn test-compile -Dtest="com.example.backend.selenium.*Test" 2>&1 | tail -20 || echo "âš ï¸ Test compile hatasÄ±"
                        
                        # JaCoCo agent'Ä± hazÄ±rla ve testleri Ã§alÄ±ÅŸtÄ±r
                        echo "ğŸ”§ JaCoCo agent hazÄ±rlanÄ±yor ve testler baÅŸlatÄ±lÄ±yor..."
                        set +e  # Hata durumunda script devam etsin
                        mvn jacoco:prepare-agent test \
                            -Djacoco.destFile=target/jacoco-selenium.exec \
                            -Djacoco.propertyName=argLine \
                            -Dtest="com.example.backend.selenium.*Test" \
                            -Dselenium.headless=true \
                            -Dfrontend.url="${FRONTEND_URL}" \
                            -Dbackend.url="${BACKEND_URL}" \
                            -Dtest.db.url="${TEST_DB_URL}" \
                            -Dtest.db.user="${TEST_DB_USER}" \
                            -Dtest.db.password="${TEST_DB_PASSWORD}" \
                            -DfailIfNoTests=false 2>&1 | tee maven-test-output.log
                        MVN_EXIT_CODE=$?
                        set -e
                        
                        # Exec dosyasÄ±nÄ± kontrol et
                        if [ -f "target/jacoco-selenium.exec" ]; then
                            echo "âœ… Selenium test exec dosyasÄ± oluÅŸturuldu: target/jacoco-selenium.exec"
                            ls -lh target/jacoco-selenium.exec
                        else
                            echo "âš ï¸ Selenium test exec dosyasÄ± oluÅŸturulamadÄ±"
                        fi
                        
                        echo "ğŸ“‹ Maven Ã§Ä±kÄ±ÅŸ kodu: ${MVN_EXIT_CODE}"
                        
                        # Maven Ã§Ä±ktÄ±sÄ±nÄ± analiz et
                        if [ -f maven-test-output.log ]; then
                            echo "ğŸ“„ Maven Ã§Ä±ktÄ±sÄ± Ã¶zeti:"
                            echo "--- Test baÅŸlatma mesajlarÄ± ---"
                            grep -iE 'test|running|executing' maven-test-output.log | head -20 || echo "Test mesajÄ± bulunamadÄ±"
                            echo "--- Hata mesajlarÄ± ---"
                            grep -iE 'error|exception|failed|timeout' maven-test-output.log | head -30 || echo "Hata mesajÄ± bulunamadÄ±"
                            echo "--- Test sonuÃ§larÄ± ---"
                            grep -E 'Tests run:|BUILD' maven-test-output.log | tail -10 || echo "Test sonucu bulunamadÄ±"
                        fi
                        
                        echo "ğŸ“Š Test sonuÃ§larÄ±:"
                        if [ -d "target/surefire-reports" ]; then
                            echo "âœ… Surefire rapor klasÃ¶rÃ¼ mevcut"
                            echo "ğŸ“ˆ Test raporu dosyalarÄ±:"
                            find target/surefire-reports -name "*.xml" -type f | sort
                            XML_COUNT=$(find target/surefire-reports -name "*.xml" -type f | wc -l)
                            echo "ğŸ“Š Toplam XML rapor sayÄ±sÄ±: ${XML_COUNT}"
                            
                            # Selenium test raporlarÄ±nÄ± Ã¶zellikle kontrol et
                            SELENIUM_XML_COUNT=$(find target/surefire-reports -name "*Selenium*Test*.xml" -type f | wc -l)
                            echo "ğŸ“Š Selenium test XML rapor sayÄ±sÄ±: ${SELENIUM_XML_COUNT}"
                            
                            if [ ${SELENIUM_XML_COUNT} -eq 0 ]; then
                                echo "âš ï¸ Selenium test raporu bulunamadÄ±!"
                                echo "ğŸ“‚ Surefire rapor klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                ls -la target/surefire-reports/ | head -20
                            else
                                echo "âœ… Selenium test raporlarÄ± bulundu"
                                # Ä°lk raporun iÃ§eriÄŸini gÃ¶ster
                                FIRST_REPORT=$(find target/surefire-reports -name "*Selenium*Test*.xml" -type f | head -1)
                                if [ -n "${FIRST_REPORT}" ]; then
                                    echo "ğŸ“„ Ä°lk rapor: ${FIRST_REPORT}"
                                    grep -E "testsuite|testcase|failure|error" "${FIRST_REPORT}" | head -10
                                fi
                            fi
                        else
                            echo "âŒ Test raporu klasÃ¶rÃ¼ bulunamadÄ± (target/surefire-reports)"
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ 2>/dev/null | head -20 || echo "target klasÃ¶rÃ¼ yok"
                        fi
                        
                        # Maven exit code'u 0 deÄŸilse uyarÄ± ver ve baÅŸarÄ±sÄ±z testleri gÃ¶ster
                        if [ ${MVN_EXIT_CODE} -ne 0 ]; then
                            echo "âš ï¸ Maven test komutu hata ile Ã§Ä±ktÄ± (kod: ${MVN_EXIT_CODE})"
                            echo "ğŸ“‹ DetaylÄ± hata bilgisi iÃ§in yukarÄ±daki loglarÄ± kontrol edin"
                            
                            # BaÅŸarÄ±sÄ±z testleri bul ve gÃ¶ster
                            echo "ğŸ” BaÅŸarÄ±sÄ±z testler aranÄ±yor..."
                            if [ -d "target/surefire-reports" ]; then
                                echo "ğŸ“Š BaÅŸarÄ±sÄ±z test raporlarÄ±:"
                                find target/surefire-reports -name "*.xml" -type f | xargs grep -l 'failures="[1-9]' 2>/dev/null | while read report; do
                                    echo "âŒ BaÅŸarÄ±sÄ±z test: ${report}"
                                    grep -E "testcase.*failure|failure message" "${report}" | head -5 || true
                                done
                                
                                # Hata mesajlarÄ±nÄ± gÃ¶ster
                                echo "ğŸ“‹ Hata mesajlarÄ±:"
                                find target/surefire-reports -name "*.xml" -type f | xargs grep -A 5 "failure message" 2>/dev/null | head -30 || echo "Hata mesajÄ± bulunamadÄ±"
                            fi
                        else
                            echo "âœ… Maven test komutu baÅŸarÄ±yla tamamlandÄ±"
                        fi
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // Selenium screenshot'larÄ±nÄ± kaydet (eÄŸer varsa)
                    archiveArtifacts artifacts: 'backend/target/screenshots/**/*', allowEmptyArchive: true
                    script {
                        // Test sonuÃ§larÄ±nÄ± Ã¶zetle
                        dir('backend') {
                            def testFiles = sh(
                                script: 'find target/surefire-reports -name "*Selenium*Test*.xml" -type f 2>/dev/null | wc -l',
                                returnStdout: true
                            ).trim()
                            echo "ğŸ“ˆ Selenium test raporu sayÄ±sÄ±: ${testFiles}"
                            
                            // Test sonuÃ§larÄ±nÄ± parse et
                            try {
                                def testResults = sh(
                                    script: 'grep -h "testsuite" target/surefire-reports/*Selenium*Test*.xml 2>/dev/null | head -1 || echo ""',
                                    returnStdout: true
                                ).trim()
                                if (testResults) {
                                    echo "ğŸ“Š Selenium test sonuÃ§larÄ±: ${testResults}"
                                }
                                
                                // BaÅŸarÄ±sÄ±z testleri bul ve gÃ¶ster
                                def failedTests = sh(
                                    script: 'find target/surefire-reports -name "*.xml" -type f | xargs grep -l \'failures="[1-9]\' 2>/dev/null | wc -l',
                                    returnStdout: true
                                ).trim()
                                if (failedTests != "0") {
                                    echo "âŒ BaÅŸarÄ±sÄ±z test sayÄ±sÄ±: ${failedTests}"
                                    echo "ğŸ“‹ BaÅŸarÄ±sÄ±z test dosyalarÄ±:"
                                    sh '''
                                        find target/surefire-reports -name "*.xml" -type f | xargs grep -l 'failures="[1-9]' 2>/dev/null | while read report; do
                                            echo "  - ${report}"
                                            grep -E "testsuite.*failures" "${report}" | head -1 || true
                                        done
                                    '''
                                }
                            } catch (Exception e) {
                                echo "âš ï¸ Test sonuÃ§larÄ± parse edilemedi: ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Code Coverage Report') {
            steps {
                echo 'TÃ¼m testler iÃ§in coverage raporu oluÅŸturuluyor...'
                dir('backend') {
                    // TÃ¼m exec dosyalarÄ±nÄ± birleÅŸtir ve rapor oluÅŸtur
                    sh '''
                        echo "ğŸ“Š Coverage raporu oluÅŸturuluyor..."
                        echo "ğŸ“‚ Mevcut exec dosyalarÄ±:"
                        ls -lh target/jacoco-*.exec 2>/dev/null || echo "Exec dosyasÄ± bulunamadÄ±"
                        
                        # Exec dosyalarÄ±nÄ± kontrol et
                        EXEC_FILES=""
                        if [ -f "target/jacoco-unit.exec" ]; then
                            EXEC_FILES="${EXEC_FILES} target/jacoco-unit.exec"
                            echo "âœ… Unit test exec dosyasÄ± bulundu"
                        fi
                        if [ -f "target/jacoco-integration.exec" ]; then
                            EXEC_FILES="${EXEC_FILES} target/jacoco-integration.exec"
                            echo "âœ… Integration test exec dosyasÄ± bulundu"
                        fi
                        if [ -f "target/jacoco-selenium.exec" ]; then
                            EXEC_FILES="${EXEC_FILES} target/jacoco-selenium.exec"
                            echo "âœ… Selenium test exec dosyasÄ± bulundu"
                        fi
                        
                        if [ -z "${EXEC_FILES}" ]; then
                            echo "âŒ HiÃ§ exec dosyasÄ± bulunamadÄ±!"
                            echo "âš ï¸ Testler daha Ã¶nce Ã§alÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ olmalÄ±ydÄ±. Exec dosyalarÄ± kontrol ediliyor..."
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ | grep -E "(jacoco|exec)" || echo "jacoco/exec dosyasÄ± bulunamadÄ±"
                            echo "âš ï¸ Exec dosyasÄ± olmadan rapor oluÅŸturulamaz. Test aÅŸamalarÄ±nÄ± kontrol edin."
                            exit 1
                        else
                            echo "ğŸ“¦ Exec dosyalarÄ± birleÅŸtiriliyor..."
                            # pom.xml'de merge execution tanÄ±mlÄ±, jacoco:merge@merge Ã§aÄŸÄ±rarak birleÅŸtir
                            # Exec dosyalarÄ± target klasÃ¶rÃ¼nde jacoco-*.exec pattern'i ile bulunacak
                            mvn jacoco:merge@merge || {
                                echo "âš ï¸ jacoco:merge baÅŸarÄ±sÄ±z, alternatif yÃ¶ntem deneniyor..."
                                # Alternatif: Ä°lk exec dosyasÄ±nÄ± kopyala (en azÄ±ndan bir coverage olur)
                                FIRST_FILE=$(echo ${EXEC_FILES} | cut -d' ' -f1)
                                if [ -f "${FIRST_FILE}" ]; then
                                    cp "${FIRST_FILE}" target/jacoco.exec
                                    echo "âš ï¸ Sadece ilk exec dosyasÄ± kullanÄ±ldÄ±: ${FIRST_FILE}"
                                else
                                    echo "âŒ Exec dosyalarÄ± birleÅŸtirilemedi ve alternatif yÃ¶ntem de baÅŸarÄ±sÄ±z oldu"
                                    exit 1
                                fi
                            }
                            
                            if [ -f "target/jacoco.exec" ]; then
                                echo "âœ… Exec dosyalarÄ± birleÅŸtirildi: target/jacoco.exec"
                                ls -lh target/jacoco.exec
                                
                                # BirleÅŸtirilmiÅŸ exec dosyasÄ±ndan rapor oluÅŸtur (testleri Ã§alÄ±ÅŸtÄ±rmadan)
                                echo "ğŸ“Š BirleÅŸtirilmiÅŸ exec dosyasÄ±ndan rapor oluÅŸturuluyor..."
                                mvn jacoco:report -DskipTests=true -Dmaven.test.skip=true -Djacoco.dataFile=target/jacoco.exec
                                echo "âœ… Coverage raporu oluÅŸturuldu"
                            else
                                echo "âŒ Exec dosyalarÄ± birleÅŸtirilemedi"
                                echo "âš ï¸ Test aÅŸamalarÄ±nÄ± kontrol edin. Exec dosyalarÄ± oluÅŸturulmuÅŸ olmalÄ±ydÄ±."
                                exit 1
                            fi
                        fi
                    '''
                    
                    // DosyanÄ±n oluÅŸtuÄŸunu kontrol et
                    sh '''
                        echo "ğŸ“‚ target/site klasÃ¶rÃ¼ kontrol ediliyor..."
                        if [ -d "target/site" ]; then
                            echo "âœ… target/site klasÃ¶rÃ¼ var"
                            ls -la target/site/
                        else
                            echo "âš ï¸ target/site klasÃ¶rÃ¼ yok, oluÅŸturuluyor..."
                            mkdir -p target/site
                        fi
                        
                        if [ -f "target/site/jacoco/index.html" ]; then
                            echo "âœ… Coverage raporu baÅŸarÄ±yla oluÅŸturuldu: target/site/jacoco/index.html"
                            ls -la target/site/jacoco/
                            echo "ğŸ“Š Rapor dosyasÄ± boyutu:"
                            du -sh target/site/jacoco/
                        else
                            echo "âŒ Coverage raporu oluÅŸturulamadÄ±"
                            echo "ğŸ“‚ target/site klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ boÅŸ"
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ | grep -E "(jacoco|site)" || echo "jacoco/site ile ilgili dosya yok"
                            echo "ğŸ” jacoco.exec dosyasÄ±nÄ± arÄ±yorum..."
                            find target -name "jacoco*.exec" 2>/dev/null || echo "jacoco exec bulunamadÄ±"
                            echo "âš ï¸ Rapor oluÅŸturulamadÄ± ama build devam ediyor..."
                        fi
                    '''
                }
            }
            post {
                always {
                    script {
                        // DosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et ve artifact olarak kaydet
                        // dir('backend') iÃ§inde dosya kontrolÃ¼ yap, ama archiveArtifacts workspace root'undan
                        def fileExists = false
                        def aggregateExists = false
                        
                        dir('backend') {
                            def coverageFile = 'target/site/jacoco/index.html'
                            def fileExistsCheck = sh(
                                script: "test -f ${coverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                returnStdout: true
                            ).trim()
                            
                            if (fileExistsCheck == 'EXISTS') {
                                fileExists = true
                                echo "âœ… Coverage raporu dosyasÄ± bulundu: ${coverageFile}"
                                sh "ls -lah target/site/jacoco/ | head -20"
                            } else {
                                // Alternatif: Aggregate raporunu kontrol et
                                def aggregateFile = 'target/site/jacoco-aggregate/index.html'
                                def aggregateExistsCheck = sh(
                                    script: "test -f ${aggregateFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                    returnStdout: true
                                ).trim()
                                
                                if (aggregateExistsCheck == 'EXISTS') {
                                    aggregateExists = true
                                } else {
                                    echo "âš ï¸ Coverage raporu bulunamadÄ±, artifact kaydedilemedi"
                                    echo "ğŸ“‚ target/site klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                    sh 'ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ yok"'
                                    echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                    sh 'ls -la target/ | head -20'
                                }
                            }
                        }
                        
                        // Workspace root'undan archive et
                        if (fileExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi!"
                        } else if (aggregateExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false
                            echo "âœ… Coverage raporu (aggregate) artifact olarak kaydedildi!"
                        }
                    }
                    echo "ğŸ“ Coverage raporuna eriÅŸmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'backend/target/site/jacoco/index.html' dosyasÄ±nÄ± indirin."
                    echo "ğŸ’¡ HTML Publisher Plugin yÃ¼klerseniz, raporlar otomatik olarak gÃ¶rÃ¼ntÃ¼lenebilir."
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'JAR dosyasÄ± oluÅŸturuluyor...'
                dir('backend') {
                    // Clean yapmadan package oluÅŸtur (coverage raporunu korumak iÃ§in)
                    // target/site klasÃ¶rÃ¼nÃ¼ korumak iÃ§in site:site goal'Ä±nÄ± atla
                    sh 'mvn package -DskipTests -Dmaven.site.skip=false'
                }
            }
            post {
                success {
                    // BaÅŸarÄ±lÄ± build sonrasÄ± JAR'Ä± kaydet
                    archiveArtifacts artifacts: 'backend/target/*.jar', allowEmptyArchive: false
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline tamamlandÄ±.'
            script {
                def testResults = sh(
                    script: 'find backend/target/surefire-reports -name "*.xml" -type f | xargs grep -l "testsuite" 2>/dev/null | wc -l',
                    returnStdout: true
                ).trim()
                echo "Test dosyasÄ± sayÄ±sÄ±: ${testResults}"
                
                // Coverage raporu bilgisi ve artifact kaydetme
                script {
                    try {
                        def fileExists = false
                        def aggregateExists = false
                        
                        dir('backend') {
                            // DosyanÄ±n gerÃ§ekten var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                            def coverageFile = 'target/site/jacoco/index.html'
                            def fileExistsCheck = sh(
                                script: "test -f ${coverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                returnStdout: true
                            ).trim()
                            
                            if (fileExistsCheck == 'EXISTS') {
                                fileExists = true
                                echo "âœ… Coverage raporu oluÅŸturuldu: ${coverageFile}"
                                sh "ls -lah target/site/jacoco/ | head -20"
                            } else {
                                // Alternatif: Aggregate raporunu kontrol et
                                def aggregateCoverageFile = 'target/site/jacoco-aggregate/index.html'
                                def aggregateExistsCheck = sh(
                                    script: "test -f ${aggregateCoverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                    returnStdout: true
                                ).trim()
                                
                                if (aggregateExistsCheck == 'EXISTS') {
                                    aggregateExists = true
                                } else {
                                    echo "âš ï¸ Coverage raporu bulunamadÄ±. target/site/jacoco/ klasÃ¶rÃ¼ kontrol ediliyor..."
                                    sh 'ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ yok"'
                                    sh 'find target -name "jacoco" -type d 2>/dev/null | head -5 || echo "jacoco klasÃ¶rÃ¼ bulunamadÄ±"'
                                }
                            }
                        }
                        
                        // Workspace root'undan archive et (dir dÄ±ÅŸÄ±nda)
                        if (fileExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false, fingerprint: true
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi!"
                            echo "ğŸ“ Coverage raporunu gÃ¶rmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'backend/target/site/jacoco/index.html' dosyasÄ±nÄ± indirin."
                        } else if (aggregateExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false, fingerprint: true
                            echo "ğŸ“Š Coverage raporu (aggregate) artifact olarak kaydedildi!"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ Coverage raporu kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                        e.printStackTrace()
                    }
                }
            }
        }
        success {
            echo 'âœ… TÃ¼m testler baÅŸarÄ±lÄ±!'
            // Ä°steÄŸe baÄŸlÄ±: Slack, Email bildirimi eklenebilir
        }
        failure {
            echo 'âŒ Testler baÅŸarÄ±sÄ±z oldu!'
            // Ä°steÄŸe baÄŸlÄ±: Hata bildirimi
        }
        unstable {
            echo 'âš ï¸ BazÄ± testler baÅŸarÄ±sÄ±z oldu!'
        }
    }
}



