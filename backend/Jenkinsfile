pipeline {
    agent any
    
    // Otomatik build tetikleme: GitHub'a push yapÄ±ldÄ±ÄŸÄ±nda veya belirli aralÄ±klarla
    triggers {
        // Poll SCM: Her 2 dakikada bir GitHub'Ä± kontrol et (yeni commit varsa build baÅŸlatÄ±r)
        pollSCM('H/2 * * * *')
        
        // Alternatif: GitHub webhook kullanmak isterseniz, Jenkins'te "GitHub hook trigger for GITScm polling" seÃ§eneÄŸini iÅŸaretleyin
        // ve bu satÄ±rÄ± yorum satÄ±rÄ± yapÄ±n
    }
    
    environment {
        // Maven ve Java PATH'leri (container'da mevcut)
        PATH = "/usr/bin:/opt/java/openjdk/bin:${env.PATH}"
        JAVA_HOME = '/opt/java/openjdk'
        M2_HOME = '/usr/share/maven'
        // Test veritabanÄ± iÃ§in (Docker Compose network iÃ§inden)
        TEST_DB_URL = 'jdbc:postgresql://postgres:5432/yazilimdogrulama_test'
        TEST_DB_USER = 'postgres'
        TEST_DB_PASSWORD = 'postgres'
        
        // Frontend URL (Selenium testleri iÃ§in - host'tan eriÅŸim)
        // Frontend host'ta Ã§alÄ±ÅŸÄ±yor, Jenkins container'Ä±ndan host.docker.internal ile eriÅŸiliyor
        FRONTEND_URL = 'http://host.docker.internal:5173'
        
        // Backend URL (Selenium testleri iÃ§in - browser'dan backend'e eriÅŸim)
        // Browser Jenkins container'Ä±nda Ã§alÄ±ÅŸÄ±yor, backend host'ta expose edilmiÅŸ
        // Browser'dan backend'e istek giderken host.docker.internal:8080 kullanÄ±lmalÄ±
        BACKEND_URL = 'http://host.docker.internal:8080'
        
        // CI ortamÄ± flag'i (Selenium headless mod iÃ§in)
        CI = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Git repository\'den kod Ã§ekiliyor...'
                checkout scm
            }
        }
        
        stage('Clean') {
            steps {
                echo 'Maven clean iÅŸlemi yapÄ±lÄ±yor...'
                dir('backend') {
                    sh 'mvn clean'
                }
            }
        }
        
        stage('Compile') {
            steps {
                echo 'Kod derleniyor...'
                dir('backend') {
                    sh 'mvn compile'
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'Unit testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                dir('backend') {
                    // Clean yapmadan test Ã§alÄ±ÅŸtÄ±r (jacoco.exec birleÅŸtirmek iÃ§in)
                    sh 'mvn test jacoco:report -Dtest="*ServiceImplTest"'
                }
            }
            post {
                always {
                    // Test sonuÃ§larÄ±nÄ± kaydet
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu artifact olarak kaydet (sadece dosya varsa)
                    script {
                        if (fileExists('backend/target/site/jacoco/index.html')) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi."
                        } else {
                            echo "âš ï¸ Coverage raporu bulunamadÄ± (Unit Tests)"
                        }
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                echo 'Entegrasyon testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    try {
                        // PostgreSQL test veritabanÄ±nÄ±n hazÄ±r olduÄŸundan emin ol
                        // Docker Compose network iÃ§inden postgres container'Ä±na eriÅŸim
                        sh '''
                            # Test veritabanÄ±nÄ± kontrol et ve oluÅŸtur (eÄŸer yoksa)
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "SELECT 1 FROM pg_database WHERE datname='yazilimdogrulama_test'" | grep -q 1 || \
                            PGPASSWORD=${TEST_DB_PASSWORD} psql -h postgres -p 5432 -U ${TEST_DB_USER} -d postgres -c "CREATE DATABASE yazilimdogrulama_test"
                        '''
                    } catch (Exception e) {
                        echo "VeritabanÄ± kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                    }
                }
                dir('backend') {
                    // Docker Compose network'Ã¼nden postgres'e eriÅŸim iÃ§in Maven system property override
                    // JaCoCo agent zaten prepare-agent ile hazÄ±rlanmÄ±ÅŸ olmalÄ±
                    sh '''
                        mvn test jacoco:report -Dtest="*IntegrationTest" \
                            -Dspring.datasource.url=jdbc:postgresql://postgres:5432/yazilimdogrulama_test \
                            -Dspring.datasource.username=postgres \
                            -Dspring.datasource.password=postgres
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // JaCoCo coverage raporunu artifact olarak kaydet (sadece dosya varsa)
                    script {
                        if (fileExists('backend/target/site/jacoco/index.html')) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi."
                        } else {
                            echo "âš ï¸ Coverage raporu bulunamadÄ± (Integration Tests)"
                        }
                    }
                }
            }
        }
        
        stage('Selenium Tests') {
            steps {
                echo 'Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                script {
                    // Frontend ve Backend'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et ve URL'leri belirle
                    def frontendAccessible = false
                    def backendAccessible = false
                    def actualFrontendUrl = env.FRONTEND_URL ?: 'http://host.docker.internal:5173'
                    def actualBackendUrl = env.BACKEND_URL ?: 'http://backend:8080'
                    
                    sh '''
                        echo "ğŸ” Servis eriÅŸilebilirlik kontrolÃ¼ yapÄ±lÄ±yor..."
                        
                        # Backend kontrolÃ¼ (Jenkins container'Ä±ndan backend container'Ä±na)
                        echo "ğŸ“¡ Backend kontrolÃ¼: http://backend:8080"
                        BACKEND_RESPONSE=$(curl -s -w "%{http_code}" --max-time 10 http://backend:8080/api/auth/kayit -o /dev/null 2>&1)
                        if [ "$BACKEND_RESPONSE" = "200" ] || [ "$BACKEND_RESPONSE" = "405" ] || [ "$BACKEND_RESPONSE" = "500" ]; then
                            echo "âœ… Backend http://backend:8080 eriÅŸilebilir (HTTP $BACKEND_RESPONSE)"
                            BACKEND_OK=1
                        else
                            echo "âŒ Backend http://backend:8080 eriÅŸilemiyor (HTTP $BACKEND_RESPONSE)"
                            BACKEND_OK=0
                        fi
                        
                        # Frontend kontrolÃ¼ (Jenkins container'Ä±ndan host'taki frontend'e)
                        echo "ğŸ“¡ Frontend kontrolÃ¼: http://host.docker.internal:5173"
                        if curl -f -s --max-time 10 http://host.docker.internal:5173 > /dev/null 2>&1; then
                            echo "âœ… Frontend http://host.docker.internal:5173 eriÅŸilebilir"
                            FRONTEND_OK=1
                        else
                            echo "âŒ Frontend http://host.docker.internal:5173 eriÅŸilemiyor"
                            FRONTEND_OK=0
                        fi
                        
                        echo "ğŸ“Š Servis durumu:"
                        if [ ${FRONTEND_OK} -eq 1 ]; then
                            echo "  Frontend: âœ… EriÅŸilebilir (http://host.docker.internal:5173)"
                        else
                            echo "  Frontend: âŒ EriÅŸilemez (http://host.docker.internal:5173)"
                        fi
                        if [ ${BACKEND_OK} -eq 1 ]; then
                            echo "  Backend: âœ… EriÅŸilebilir (http://backend:8080)"
                        else
                            echo "  Backend: âŒ EriÅŸilemez (http://backend:8080)"
                        fi
                        
                        if [ ${FRONTEND_OK} -eq 0 ]; then
                            echo "âš ï¸ UYARI: Frontend eriÅŸilemiyor"
                            echo "âš ï¸ Frontend'in localhost:5173'te Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun."
                        fi
                        
                        if [ ${BACKEND_OK} -eq 0 ]; then
                            echo "âš ï¸ UYARI: Backend eriÅŸilemiyor"
                            echo "âš ï¸ Backend container'Ä±nÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun."
                        fi
                    '''
                }
                dir('backend') {
                    sh '''
                        echo "ğŸ§ª Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                        echo "ğŸ“¡ Frontend URL: ${FRONTEND_URL}"
                        echo "ğŸ“¡ Backend URL: ${BACKEND_URL}"
                        echo "ğŸ“¡ Test DB URL: ${TEST_DB_URL}"
                        echo "ğŸ“¡ Test DB User: ${TEST_DB_USER}"
                        
                        # Test sayÄ±sÄ±nÄ± gÃ¶ster
                        echo "ğŸ“Š Selenium test sÄ±nÄ±flarÄ±:"
                        find src/test/java/com/example/backend/selenium -name "*Test.java" -type f | sort
                        TEST_COUNT=$(find src/test/java/com/example/backend/selenium -name "*Test.java" -type f | wc -l)
                        echo "ğŸ“Š Toplam test sÄ±nÄ±fÄ± sayÄ±sÄ±: ${TEST_COUNT}"
                        
                        # Maven'in testleri bulup bulamadÄ±ÄŸÄ±nÄ± kontrol et
                        echo "ğŸ” Maven test discovery kontrolÃ¼..."
                        echo "Test pattern: com.example.backend.selenium.*Test"
                        mvn test-compile -Dtest="com.example.backend.selenium.*Test" 2>&1 | tail -20 || echo "âš ï¸ Test compile hatasÄ±"
                        
                        # Testleri Ã§alÄ±ÅŸtÄ±r (hata olsa bile devam et, ama hatalarÄ± gÃ¶ster)
                        echo "ğŸš€ Selenium testleri baÅŸlatÄ±lÄ±yor..."
                        set +e  # Hata durumunda script devam etsin
                        mvn test jacoco:report -Dtest="com.example.backend.selenium.*Test" -Dselenium.headless=true \
                            -Dfrontend.url="${FRONTEND_URL}" \
                            -Dbackend.url="${BACKEND_URL}" \
                            -Dtest.db.url="${TEST_DB_URL}" \
                            -Dtest.db.user="${TEST_DB_USER}" \
                            -Dtest.db.password="${TEST_DB_PASSWORD}" \
                            -DfailIfNoTests=false 2>&1 | tee maven-test-output.log
                        MVN_EXIT_CODE=$?
                        set -e
                        
                        echo "ğŸ“‹ Maven Ã§Ä±kÄ±ÅŸ kodu: ${MVN_EXIT_CODE}"
                        
                        # Maven Ã§Ä±ktÄ±sÄ±nÄ± analiz et
                        if [ -f maven-test-output.log ]; then
                            echo "ğŸ“„ Maven Ã§Ä±ktÄ±sÄ± Ã¶zeti:"
                            echo "--- Test baÅŸlatma mesajlarÄ± ---"
                            grep -iE 'test|running|executing' maven-test-output.log | head -20 || echo "Test mesajÄ± bulunamadÄ±"
                            echo "--- Hata mesajlarÄ± ---"
                            grep -iE 'error|exception|failed|timeout' maven-test-output.log | head -30 || echo "Hata mesajÄ± bulunamadÄ±"
                            echo "--- Test sonuÃ§larÄ± ---"
                            grep -E 'Tests run:|BUILD' maven-test-output.log | tail -10 || echo "Test sonucu bulunamadÄ±"
                        fi
                        
                        echo "ğŸ“Š Test sonuÃ§larÄ±:"
                        if [ -d "target/surefire-reports" ]; then
                            echo "âœ… Surefire rapor klasÃ¶rÃ¼ mevcut"
                            echo "ğŸ“ˆ Test raporu dosyalarÄ±:"
                            find target/surefire-reports -name "*.xml" -type f | sort
                            XML_COUNT=$(find target/surefire-reports -name "*.xml" -type f | wc -l)
                            echo "ğŸ“Š Toplam XML rapor sayÄ±sÄ±: ${XML_COUNT}"
                            
                            # Selenium test raporlarÄ±nÄ± Ã¶zellikle kontrol et
                            SELENIUM_XML_COUNT=$(find target/surefire-reports -name "*Selenium*Test*.xml" -type f | wc -l)
                            echo "ğŸ“Š Selenium test XML rapor sayÄ±sÄ±: ${SELENIUM_XML_COUNT}"
                            
                            if [ ${SELENIUM_XML_COUNT} -eq 0 ]; then
                                echo "âš ï¸ Selenium test raporu bulunamadÄ±!"
                                echo "ğŸ“‚ Surefire rapor klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                ls -la target/surefire-reports/ | head -20
                            else
                                echo "âœ… Selenium test raporlarÄ± bulundu"
                                # Ä°lk raporun iÃ§eriÄŸini gÃ¶ster
                                FIRST_REPORT=$(find target/surefire-reports -name "*Selenium*Test*.xml" -type f | head -1)
                                if [ -n "${FIRST_REPORT}" ]; then
                                    echo "ğŸ“„ Ä°lk rapor: ${FIRST_REPORT}"
                                    grep -E "testsuite|testcase|failure|error" "${FIRST_REPORT}" | head -10
                                fi
                            fi
                        else
                            echo "âŒ Test raporu klasÃ¶rÃ¼ bulunamadÄ± (target/surefire-reports)"
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ 2>/dev/null | head -20 || echo "target klasÃ¶rÃ¼ yok"
                        fi
                        
                        # Maven exit code'u 0 deÄŸilse uyarÄ± ver
                        if [ ${MVN_EXIT_CODE} -ne 0 ]; then
                            echo "âš ï¸ Maven test komutu hata ile Ã§Ä±ktÄ± (kod: ${MVN_EXIT_CODE})"
                            echo "ğŸ“‹ DetaylÄ± hata bilgisi iÃ§in yukarÄ±daki loglarÄ± kontrol edin"
                        else
                            echo "âœ… Maven test komutu baÅŸarÄ±yla tamamlandÄ±"
                        fi
                    '''
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    // Selenium screenshot'larÄ±nÄ± kaydet (eÄŸer varsa)
                    archiveArtifacts artifacts: 'backend/target/screenshots/**/*', allowEmptyArchive: true
                    script {
                        // Test sonuÃ§larÄ±nÄ± Ã¶zetle
                        dir('backend') {
                            def testFiles = sh(
                                script: 'find target/surefire-reports -name "*Selenium*Test*.xml" -type f 2>/dev/null | wc -l',
                                returnStdout: true
                            ).trim()
                            echo "ğŸ“ˆ Selenium test raporu sayÄ±sÄ±: ${testFiles}"
                            
                            // Test sonuÃ§larÄ±nÄ± parse et
                            try {
                                def testResults = sh(
                                    script: 'grep -h "testsuite" target/surefire-reports/*Selenium*Test*.xml 2>/dev/null | head -1 || echo ""',
                                    returnStdout: true
                                ).trim()
                                if (testResults) {
                                    echo "ğŸ“Š Selenium test sonuÃ§larÄ±: ${testResults}"
                                }
                            } catch (Exception e) {
                                echo "âš ï¸ Test sonuÃ§larÄ± parse edilemedi: ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Code Coverage Report') {
            steps {
                echo 'TÃ¼m testler iÃ§in coverage raporu oluÅŸturuluyor...'
                dir('backend') {
                    // Ã–nce jacoco.exec dosyasÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
                    sh '''
                        echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                        ls -la target/ 2>/dev/null | head -20 || echo "target klasÃ¶rÃ¼ yok"
                        
                        if [ -f "target/jacoco.exec" ]; then
                            echo "âœ… jacoco.exec dosyasÄ± bulundu"
                            ls -lh target/jacoco.exec
                        else
                            echo "âš ï¸ jacoco.exec dosyasÄ± bulunamadÄ±"
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ 2>/dev/null || echo "target klasÃ¶rÃ¼ yok"
                            echo "ğŸ” jacoco.exec dosyasÄ±nÄ± arÄ±yorum..."
                            find target -name "jacoco.exec" 2>/dev/null || echo "jacoco.exec bulunamadÄ±"
                        fi
                    '''
                    
                    // Coverage raporu oluÅŸtur (clean yapmadan, sadece report)
                    sh '''
                        echo "ğŸ“Š Coverage raporu oluÅŸturuluyor..."
                        # jacoco.exec varsa sadece rapor oluÅŸtur
                        if [ -f "target/jacoco.exec" ]; then
                            echo "âœ… jacoco.exec bulundu, rapor oluÅŸturuluyor..."
                            # Sadece jacoco:report Ã§alÄ±ÅŸtÄ±r (site:site Ã§ok uzun sÃ¼rer ve gerekli deÄŸil)
                            mvn jacoco:report -DskipTests=true
                            echo "âœ… Coverage raporu oluÅŸturuldu"
                        else
                            echo "âš ï¸ jacoco.exec bulunamadÄ±, tÃ¼m testleri Ã§alÄ±ÅŸtÄ±rÄ±p rapor oluÅŸturuyoruz..."
                            # Clean yapmadan testleri Ã§alÄ±ÅŸtÄ±r (target klasÃ¶rÃ¼nÃ¼ korumak iÃ§in)
                            # Sadece unit testleri Ã§alÄ±ÅŸtÄ±r (Selenium testleri frontend gerektirir)
                            mvn test jacoco:report -Dtest="*Test" -DfailIfNoTests=false || echo "Test hatasÄ± olsa bile rapor oluÅŸturulmaya Ã§alÄ±ÅŸÄ±lÄ±yor"
                        fi
                    '''
                    
                    // DosyanÄ±n oluÅŸtuÄŸunu kontrol et
                    sh '''
                        echo "ğŸ“‚ target/site klasÃ¶rÃ¼ kontrol ediliyor..."
                        if [ -d "target/site" ]; then
                            echo "âœ… target/site klasÃ¶rÃ¼ var"
                            ls -la target/site/
                        else
                            echo "âš ï¸ target/site klasÃ¶rÃ¼ yok, oluÅŸturuluyor..."
                            mkdir -p target/site
                        fi
                        
                        if [ -f "target/site/jacoco/index.html" ]; then
                            echo "âœ… Coverage raporu baÅŸarÄ±yla oluÅŸturuldu: target/site/jacoco/index.html"
                            ls -la target/site/jacoco/
                            echo "ğŸ“Š Rapor dosyasÄ± boyutu:"
                            du -sh target/site/jacoco/
                        else
                            echo "âŒ Coverage raporu oluÅŸturulamadÄ±"
                            echo "ğŸ“‚ target/site klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ boÅŸ"
                            echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                            ls -la target/ | grep -E "(jacoco|site)" || echo "jacoco/site ile ilgili dosya yok"
                            echo "ğŸ” jacoco.exec dosyasÄ±nÄ± arÄ±yorum..."
                            find target -name "jacoco.exec" 2>/dev/null || echo "jacoco.exec bulunamadÄ±"
                            echo "âš ï¸ Rapor oluÅŸturulamadÄ± ama build devam ediyor..."
                        fi
                    '''
                }
            }
            post {
                always {
                    script {
                        // DosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et ve artifact olarak kaydet
                        // dir('backend') iÃ§inde dosya kontrolÃ¼ yap, ama archiveArtifacts workspace root'undan
                        def fileExists = false
                        def aggregateExists = false
                        
                        dir('backend') {
                            def coverageFile = 'target/site/jacoco/index.html'
                            def fileExistsCheck = sh(
                                script: "test -f ${coverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                returnStdout: true
                            ).trim()
                            
                            if (fileExistsCheck == 'EXISTS') {
                                fileExists = true
                                echo "âœ… Coverage raporu dosyasÄ± bulundu: ${coverageFile}"
                                sh "ls -lah target/site/jacoco/ | head -20"
                            } else {
                                // Alternatif: Aggregate raporunu kontrol et
                                def aggregateFile = 'target/site/jacoco-aggregate/index.html'
                                def aggregateExistsCheck = sh(
                                    script: "test -f ${aggregateFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                    returnStdout: true
                                ).trim()
                                
                                if (aggregateExistsCheck == 'EXISTS') {
                                    aggregateExists = true
                                } else {
                                    echo "âš ï¸ Coverage raporu bulunamadÄ±, artifact kaydedilemedi"
                                    echo "ğŸ“‚ target/site klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                    sh 'ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ yok"'
                                    echo "ğŸ“‚ target klasÃ¶rÃ¼ iÃ§eriÄŸi:"
                                    sh 'ls -la target/ | head -20'
                                }
                            }
                        }
                        
                        // Workspace root'undan archive et
                        if (fileExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi!"
                        } else if (aggregateExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false
                            echo "âœ… Coverage raporu (aggregate) artifact olarak kaydedildi!"
                        }
                    }
                    echo "ğŸ“ Coverage raporuna eriÅŸmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'backend/target/site/jacoco/index.html' dosyasÄ±nÄ± indirin."
                    echo "ğŸ’¡ HTML Publisher Plugin yÃ¼klerseniz, raporlar otomatik olarak gÃ¶rÃ¼ntÃ¼lenebilir."
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'JAR dosyasÄ± oluÅŸturuluyor...'
                dir('backend') {
                    // Clean yapmadan package oluÅŸtur (coverage raporunu korumak iÃ§in)
                    // target/site klasÃ¶rÃ¼nÃ¼ korumak iÃ§in site:site goal'Ä±nÄ± atla
                    sh 'mvn package -DskipTests -Dmaven.site.skip=false'
                }
            }
            post {
                success {
                    // BaÅŸarÄ±lÄ± build sonrasÄ± JAR'Ä± kaydet
                    archiveArtifacts artifacts: 'backend/target/*.jar', allowEmptyArchive: false
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline tamamlandÄ±.'
            script {
                def testResults = sh(
                    script: 'find backend/target/surefire-reports -name "*.xml" -exec grep -l "testsuite" {} \\; | wc -l',
                    returnStdout: true
                ).trim()
                echo "Test dosyasÄ± sayÄ±sÄ±: ${testResults}"
                
                // Coverage raporu bilgisi ve artifact kaydetme
                script {
                    try {
                        def fileExists = false
                        def aggregateExists = false
                        
                        dir('backend') {
                            // DosyanÄ±n gerÃ§ekten var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                            def coverageFile = 'target/site/jacoco/index.html'
                            def fileExistsCheck = sh(
                                script: "test -f ${coverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                returnStdout: true
                            ).trim()
                            
                            if (fileExistsCheck == 'EXISTS') {
                                fileExists = true
                                echo "âœ… Coverage raporu oluÅŸturuldu: ${coverageFile}"
                                sh "ls -lah target/site/jacoco/ | head -20"
                            } else {
                                // Alternatif: Aggregate raporunu kontrol et
                                def aggregateCoverageFile = 'target/site/jacoco-aggregate/index.html'
                                def aggregateExistsCheck = sh(
                                    script: "test -f ${aggregateCoverageFile} && echo 'EXISTS' || echo 'NOT_EXISTS'",
                                    returnStdout: true
                                ).trim()
                                
                                if (aggregateExistsCheck == 'EXISTS') {
                                    aggregateExists = true
                                } else {
                                    echo "âš ï¸ Coverage raporu bulunamadÄ±. target/site/jacoco/ klasÃ¶rÃ¼ kontrol ediliyor..."
                                    sh 'ls -la target/site/ 2>/dev/null || echo "target/site klasÃ¶rÃ¼ yok"'
                                    sh 'find target -name "jacoco" -type d 2>/dev/null | head -5 || echo "jacoco klasÃ¶rÃ¼ bulunamadÄ±"'
                                }
                            }
                        }
                        
                        // Workspace root'undan archive et (dir dÄ±ÅŸÄ±nda)
                        if (fileExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco/**/*', allowEmptyArchive: false, fingerprint: true
                            echo "ğŸ“Š Coverage raporu artifact olarak kaydedildi!"
                            echo "ğŸ“ Coverage raporunu gÃ¶rmek iÃ§in: Build sayfasÄ±nda 'Artifacts' bÃ¶lÃ¼mÃ¼nden 'backend/target/site/jacoco/index.html' dosyasÄ±nÄ± indirin."
                        } else if (aggregateExists) {
                            archiveArtifacts artifacts: 'backend/target/site/jacoco-aggregate/**/*', allowEmptyArchive: false, fingerprint: true
                            echo "ğŸ“Š Coverage raporu (aggregate) artifact olarak kaydedildi!"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ Coverage raporu kontrolÃ¼ atlandÄ±: ${e.getMessage()}"
                        e.printStackTrace()
                    }
                }
            }
        }
        success {
            echo 'âœ… TÃ¼m testler baÅŸarÄ±lÄ±!'
            // Ä°steÄŸe baÄŸlÄ±: Slack, Email bildirimi eklenebilir
        }
        failure {
            echo 'âŒ Testler baÅŸarÄ±sÄ±z oldu!'
            // Ä°steÄŸe baÄŸlÄ±: Hata bildirimi
        }
        unstable {
            echo 'âš ï¸ BazÄ± testler baÅŸarÄ±sÄ±z oldu!'
        }
    }
}



